<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTeX CSS Loading Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-math {
            background: #f9f9f9;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #007cba;
            border-radius: 4px;
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>WebTeX CSS Loading Test</h1>
    
    <div id="status" class="status error">Loading...</div>
    
    <div class="debug-section">
        <h3>Debug Information</h3>
        <div id="debug-info">Collecting debug info...</div>
    </div>

    <div class="test-math">
        <h3>CSS Loading Test Cases:</h3>
        
        <p><strong>Square Root Test:</strong> $\sqrt{x^2 + y^2}$ (should not take full width)</p>
        
        <p><strong>Fraction Test:</strong> $\frac{1}{2} + \frac{1}{3} = \frac{5}{6}$ (should render properly)</p>
        
        <p><strong>Nuclear Notation:</strong> $\text{{}^{A}N} \rightarrow {}{}^{A-4}_{Z-2}\text{N'} + {}{}^{4}_{2}He$</p>
        
        <p><strong>Complex Expression:</strong> $\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$</p>
        
        <p><strong>Limit:</strong> $\lim_{x \to \infty} \frac{1}{x} = 0$</p>
        
        <p><strong>Matrix:</strong> $\begin{pmatrix} a & b \\ c & d \end{pmatrix}$</p>
    </div>

    <div class="debug-section">
        <h3>Expected Results:</h3>
        <ul>
            <li>✅ No "Resources must be listed in web_accessible_resources" errors</li>
            <li>✅ No "GET chrome-extension://invalid/" errors</li>
            <li>✅ Square root symbol should be normal size, not full width</li>
            <li>✅ All math expressions should render correctly</li>
            <li>✅ CSS should load without errors</li>
        </ul>
    </div>

    <script>
        let logs = [];
        
        // Capture console errors
        const originalError = console.error;
        console.error = (...args) => {
            originalError(...args);
            logs.push({ type: 'ERROR', message: args.join(' '), time: new Date().toISOString() });
            updateDebugInfo();
        };

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            
            // Check for CSS loading
            const webTexCSS = document.querySelector('style[id*="webtex"]');
            const katexElements = document.querySelectorAll('.katex');
            const hasRendererState = window.rendererState;
            
            // Check for specific error patterns
            const cssErrors = logs.filter(log => 
                log.message.includes('web_accessible_resources') || 
                log.message.includes('chrome-extension://invalid')
            );
            
            const info = `
                <strong>WebTeX Status:</strong><br>
                • Renderer State: ${hasRendererState ? '✅ Found' : '❌ Not Found'}<br>
                • CSS Injected: ${webTexCSS ? '✅ Yes' : '❌ No'}<br>
                • KaTeX Elements: ${katexElements.length}<br>
                • CSS Errors: ${cssErrors.length}<br><br>
                
                <strong>Recent Errors:</strong><br>
                ${cssErrors.length > 0 ? 
                    cssErrors.map(err => `❌ ${err.message}`).join('<br>') : 
                    '✅ No CSS loading errors'}<br><br>
                
                <strong>Font Loading:</strong><br>
                ${document.fonts ? 
                    `• Font API Available: Yes<br>• Loaded Fonts: ${document.fonts.size}` : 
                    '• Font API: Not Available'}<br><br>
                
                <strong>Extension Details:</strong><br>
                • Extension ID: ${typeof chrome !== 'undefined' && chrome.runtime ? chrome.runtime.id : 'Not Available'}<br>
                • Domain: ${location.hostname || 'localhost'}<br>
                • Protocol: ${location.protocol}
            `;
            
            debugInfo.innerHTML = info;
        }

        function updateStatus() {
            const status = document.getElementById('status');
            const hasRendererState = window.rendererState;
            const hasKatexElements = document.querySelectorAll('.katex').length > 0;
            const hasWebTexCSS = document.querySelector('style[id*="webtex"]');
            
            if (hasRendererState || hasKatexElements || hasWebTexCSS) {
                status.className = 'status success';
                status.innerHTML = '✅ WebTeX Active - CSS Loading Test';
            } else {
                status.className = 'status error';
                status.innerHTML = '❌ WebTeX Not Detected';
            }
        }

        // Auto-enable for testing
        (async function() {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                try {
                    const domain = location.hostname || 'localhost';
                    const result = await chrome.storage.local.get('allowedDomains');
                    const domains = result.allowedDomains || [];
                    
                    if (!domains.includes(domain)) {
                        domains.push(domain);
                        await chrome.storage.local.set({ allowedDomains: domains });
                        console.log('Auto-enabled WebTeX for testing');
                    }
                } catch (e) {
                    console.log('Could not auto-enable (normal in some contexts)');
                }
            }
        })();

        // Update status and debug info regularly
        setInterval(() => {
            updateStatus();
            updateDebugInfo();
        }, 2000);

        // Initial update after page load
        setTimeout(() => {
            updateStatus();
            updateDebugInfo();
        }, 1000);

        console.log('WebTeX CSS Loading Test Page Ready');
    </script>
</body>
</html>