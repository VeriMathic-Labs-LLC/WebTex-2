<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTeX Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .test-math {
            background: #f9f9f9;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #007cba;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>WebTeX Debug Test</h1>
    
    <div id="status" class="status error">Loading...</div>
    
    <div class="debug-info">
        <strong>Debug Information:</strong><br>
        <div id="debug-output">Collecting debug info...</div>
    </div>

    <div class="test-math">
        <h3>Test Math Expressions:</h3>
        <p>Simple: $x^2 + y^2 = z^2$</p>
        <p>Fraction: $\frac{1}{2} + \frac{1}{3} = \frac{5}{6}$</p>
        <p>Nuclear: $\text{{}^{A}N} \rightarrow {}{}^{A-4}_{Z-2}\text{N'} + {}{}^{4}_{2}He$</p>
        <p>Limit: $\lim_{x \to \infty} \frac{1}{x} = 0$</p>
    </div>

    <script>
        // Debug logging
        const originalLog = console.log;
        const originalError = console.error;
        const originalDebug = console.debug;
        
        let logs = [];
        
        function captureLog(level, ...args) {
            logs.push({ level, message: args.join(' '), timestamp: new Date().toISOString() });
            updateDebugOutput();
        }
        
        console.log = (...args) => {
            originalLog(...args);
            captureLog('LOG', ...args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            captureLog('ERROR', ...args);
        };
        
        console.debug = (...args) => {
            originalDebug(...args);
            captureLog('DEBUG', ...args);
        };

        function updateDebugOutput() {
            const output = document.getElementById('debug-output');
            const recent = logs.slice(-10); // Show last 10 logs
            
            const debugInfo = `
                <strong>Recent Console Messages:</strong><br>
                ${recent.map(log => `[${log.level}] ${log.message}`).join('<br>')}<br><br>
                
                <strong>Current State:</strong><br>
                • window.rendererState: ${window.rendererState ? 'FOUND' : 'NOT FOUND'}<br>
                • WebTeX CSS: ${document.querySelector('style[id*="webtex"]') ? 'INJECTED' : 'NOT FOUND'}<br>
                • KaTeX elements: ${document.querySelectorAll('.katex').length}<br>
                • WebTeX elements: ${document.querySelectorAll('.webtex-katex-rendered, .webtex-custom-rendered').length}<br>
                • Domain: ${location.hostname || 'localhost'}<br>
                • Protocol: ${location.protocol}<br>
                • Pathname: ${location.pathname}<br><br>
                
                <strong>Storage Check:</strong><br>
                <div id="storage-info">Checking storage...</div>
            `;
            
            output.innerHTML = debugInfo;
            
            // Check storage
            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.get('allowedDomains').then(result => {
                    const domains = result.allowedDomains || [];
                    document.getElementById('storage-info').innerHTML = 
                        `Allowed domains: [${domains.join(', ')}]<br>Current domain allowed: ${domains.includes(location.hostname)}`;
                }).catch(e => {
                    document.getElementById('storage-info').innerHTML = `Storage error: ${e.message}`;
                });
            } else {
                document.getElementById('storage-info').innerHTML = 'Chrome storage API not available';
            }
        }

        function updateStatus() {
            const status = document.getElementById('status');
            
            const hasRendererState = window.rendererState;
            const hasWebTexElements = document.querySelectorAll('.webtex-katex-rendered, .webtex-custom-rendered, .katex').length > 0;
            const hasWebTexCSS = document.querySelector('style[id*="webtex"]');
            
            if (hasRendererState || hasWebTexElements || hasWebTexCSS) {
                const stats = window.rendererState || {};
                const total = stats.totalAttempts || 0;
                const success = (stats.katexSuccess || 0) + (stats.customParserFallback || 0);
                const rate = total > 0 ? (success / total * 100).toFixed(1) : '0';
                
                status.className = 'status success';
                status.innerHTML = `✅ WebTeX Active | Rendered: ${total} | Success: ${rate}%`;
            } else {
                status.className = 'status error';
                status.innerHTML = '❌ WebTeX not detected';
            }
        }

        // Auto-enable for testing
        (async function() {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                try {
                    const domain = location.hostname || 'localhost';
                    const result = await chrome.storage.local.get('allowedDomains');
                    const domains = result.allowedDomains || [];
                    
                    if (!domains.includes(domain)) {
                        domains.push(domain);
                        await chrome.storage.local.set({ allowedDomains: domains });
                        console.log('Added domain to allowed list:', domain);
                    }
                } catch (e) {
                    console.log('Could not auto-enable (normal for content script context)');
                }
            }
        })();

        // Update status and debug info regularly
        setInterval(() => {
            updateStatus();
            updateDebugOutput();
        }, 2000);

        // Initial update
        setTimeout(() => {
            updateStatus();
            updateDebugOutput();
        }, 1000);

        console.log('WebTeX Debug Test Page Loaded');
    </script>
</body>
</html>