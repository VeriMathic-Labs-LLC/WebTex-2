<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTeX CSP Fixes Test</title>
    <!-- Simulate a CSP meta tag like GitHub might have -->
    <meta http-equiv="Content-Security-Policy" content="font-src 'self' github.githubassets.com; style-src 'self' 'unsafe-inline';">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f6f8fa;
            color: #24292f;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            background-color: white;
        }
        .test-section h3 {
            margin-top: 0;
            color: #24292f;
        }
        .math-example {
            background: #f6f8fa;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #0969da;
            border-radius: 6px;
        }
        .description {
            color: #656d76;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .expected {
            background: #dafbe1;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #1a7f37;
            border-radius: 6px;
        }
        .warning {
            background: #fff8c5;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #9a6700;
            border-radius: 6px;
        }
        .console-log {
            background: #f6f8fa;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>WebTeX CSP Fixes Test</h1>
    <p>This page simulates a CSP-protected site (like GitHub) to test the font loading fixes.</p>

    <div class="warning">
        <strong>Note:</strong> This page includes a Content Security Policy meta tag that restricts font loading, similar to GitHub's CSP.
    </div>

    <div class="test-section">
        <h3>CSP Detection Test</h3>
        <div class="description">The extension should detect the CSP meta tag and use the custom renderer proactively.</div>
        
        <div class="console-log">
            <strong>Expected Console Messages:</strong><br>
            • "CSP-protected site detected, will use custom renderer to avoid font loading issues"<br>
            • "Using custom renderer for nuclear physics content"<br>
            • No "Refused to load the font" errors<br>
            • No "Content Security Policy" violations
        </div>
    </div>

    <div class="test-section">
        <h3>Font Error Prevention Test</h3>
        <div class="description">Test that font-related errors are prevented by using the custom renderer.</div>
        
        <div class="math-example">
            <strong>Fractions (typically cause font errors):</strong><br>
            $\frac{1}{2}$ - One half<br>
            $\frac{1}{3}$ - One third<br>
            $\frac{2}{3}$ - Two thirds<br>
            $\frac{1}{4}$ - One quarter<br>
            $\frac{3}{4}$ - Three quarters
        </div>
        
        <div class="math-example">
            <strong>Complex fractions:</strong><br>
            $$\frac{\frac{1}{2} + \frac{1}{3}}{\frac{1}{4} + \frac{1}{5}} = \frac{50}{27}$$
        </div>
        
        <div class="expected">
            <strong>Expected:</strong> All fractions should render without font loading errors.
        </div>
    </div>

    <div class="test-section">
        <h3>Nuclear Physics Content Test</h3>
        <div class="description">Test nuclear physics notation that was causing parsing errors.</div>
        
        <div class="math-example">
            <strong>Nuclear notation:</strong><br>
            $\text{_Z^A X}$ - Basic nuclear notation<br>
            $\text{_88^226 Ra} \to \text{_86^222 Rn} + \text{_2^4 He}$ - Alpha decay<br>
            $\text{_6^14 C} \to \text{_7^14 N} + \text{e^-} + \bar{\nu}$ - Beta decay
        </div>
        
        <div class="expected">
            <strong>Expected:</strong> Nuclear notation should render properly without parsing errors.
        </div>
    </div>

    <div class="test-section">
        <h3>Mixed Content Test</h3>
        <div class="description">Test mixed content with different types of mathematical expressions.</div>
        
        <div class="math-example">
            <strong>Mixed expressions:</strong><br>
            The probability is $\frac{1}{2}$ or 50%.<br>
            For nuclear decay: $\text{_Z^A N} \to \text{_Z^A N} + \gamma$<br>
            The area is $A = \pi r^2$ where $\pi \approx 3.14159$<br>
            Complex equation: $$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$
        </div>
        
        <div class="expected">
            <strong>Expected:</strong> All expressions should render consistently with the custom renderer.
        </div>
    </div>

    <div class="test-section">
        <h3>Performance Test</h3>
        <div class="description">Test that the debounced rendering prevents excessive calls.</div>
        
        <div class="console-log">
            <strong>Check Console:</strong><br>
            • Should see "Using custom renderer for nuclear physics content" only once<br>
            • No repeated rendering messages<br>
            • No excessive error messages
        </div>
    </div>

    <div class="test-section">
        <h3>Error Prevention Summary</h3>
        <div class="description">The extension should prevent these specific errors:</div>
        <div class="warning">
            <ul>
                <li><strong>Font Loading Errors:</strong> "Refused to load the font '&lt;URL&gt;' because it violates the following Content Security Policy directive: 'font-src github.githubassets.com'"</li>
                <li><strong>CSP Violations:</strong> Any Content Security Policy violations related to font loading</li>
                <li><strong>Character Metrics Errors:</strong> "No character metrics for '½' in style 'Main-Regular' and mode 'text'"</li>
                <li><strong>Connection Errors:</strong> "Failed to load resource: net::ERR_CONNECTION_CLOSED"</li>
                <li><strong>Excessive Rendering:</strong> Multiple repeated rendering calls</li>
            </ul>
        </div>
    </div>

    <script>
        // Add some dynamic content to test SPA-like behavior
        setTimeout(() => {
            const newSection = document.createElement('div');
            newSection.className = 'test-section';
            newSection.innerHTML = `
                <h3>Dynamically Added Content</h3>
                <div class="description">This section was added dynamically to test SPA navigation detection with CSP protection.</div>
                <div class="math-example">
                    <strong>Dynamic math:</strong><br>
                    $\frac{1}{7} + \frac{2}{7} = \frac{3}{7}$<br>
                    Nuclear reaction: $\text{_92^235 U} + \text{_0^1 n} \to \text{_56^141 Ba} + \text{_36^92 Kr} + 3\text{_0^1 n}$
                </div>
            `;
            document.body.appendChild(newSection);
        }, 2000);
    </script>
</body>
</html> 